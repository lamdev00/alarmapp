<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wake-up Alarm</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            background: #f4f4f9;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            margin: 20px auto;
        }

        h1 {
            color: #2575fc;
            margin-bottom: 30px;
        }

        .alarm-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        input[type="time"] {
            padding: 12px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 200px;
            margin: 0 auto;
        }

        button {
            padding: 12px 24px;
            background-color: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #1a5bb8;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .alarm-list {
            text-align: left;
            margin-top: 30px;
        }

        .alarm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .alarm-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #2575fc;
        }

        .alarm-controls {
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-button {
            padding: 10px 20px;
            background-color: #2575fc;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .nav-button:hover {
            background-color: #1a5bb8;
        }

        #currentTime {
            font-size: 2.5em;
            font-weight: bold;
            color: #2575fc;
            margin: 20px 0;
        }

        /* Time Picker Styles */
        .time-picker {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: #1c1c1e;
            padding: 20px;
            border-radius: 15px;
            color: white;
            margin: 20px auto;
            width: fit-content;
        }

        .scroll-select {
            height: 100px;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            position: relative;
            background: #2c2c2e;
            border-radius: 8px;
            padding: 0 20px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .scroll-select::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .scroll-select div {
            height: 40px;
            line-height: 40px;
            font-size: 24px;
            scroll-snap-align: center;
            color: #666;
            cursor: pointer;
            text-align: center;
        }

        .scroll-select div.selected {
            color: white;
            font-size: 28px;
        }

        .time-divider {
            font-size: 24px;
            padding: 0 5px;
        }

        .period-select {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .period-btn {
            padding: 10px;
            background: #2c2c2e;
            border: none;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
        }

        .period-btn.selected {
            color: white;
            background: #2575fc;
        }

        .alarm-stages {
            font-size: 0.9em;
            color: #666;
            margin-left: 15px;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="nav-buttons">
        <a href="index.html" class="nav-button">Home</a>
        <a href="calendar.html" class="nav-button">Calendar</a>
    </div>

    <div class="container">
        <h1>Wake-up Alarm</h1>
        
        <div id="currentTime">00:00:00</div>

        <div class="alarm-form">
            <div class="time-picker">
                <div class="scroll-select hours" id="hourSelect">
                    <!-- Hours will be populated by JavaScript -->
                </div>
                <span class="time-divider">:</span>
                <div class="scroll-select minutes" id="minuteSelect">
                    <!-- Minutes will be populated by JavaScript -->
                </div>
                <div class="period-select">
                    <button class="period-btn selected" id="amBtn">AM</button>
                    <button class="period-btn" id="pmBtn">PM</button>
                </div>
            </div>
            
            <button onclick="setAlarm()">Set Alarm</button>
        </div>

        <div class="alarm-list" id="alarmsList">
            <!-- Alarms will be listed here -->
        </div>
    </div>

    <!-- Add shared.js before the inline script -->
    <script src="shared.js"></script>
    <script src="dictation.js"></script>
    <script src="appData.js"></script>
    <script>
        let alarms = [];
        let alarmSound = null;

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;

            // Check alarms
            checkAlarms(now);
        }

        setInterval(updateTime, 1000);

        // Add this new function for infinite scrolling
        function createInfiniteScrollList(element, items, itemHeight = 40) {
            const totalHeight = items.length * itemHeight;
            let isScrolling = false;
            
            // Add extra items for smooth infinite scroll
            function populateItems() {
                element.innerHTML = '';
                // Add items three times to ensure smooth scrolling
                for (let i = 0; i < 3; i++) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item;
                        element.appendChild(div);
                    });
                }
            }
            
            populateItems();
            
            // Set initial scroll position to middle set of items
            element.scrollTop = totalHeight;
            
            element.addEventListener('scroll', () => {
                if (!isScrolling) {
                    const children = element.children;
                    const elementHeight = itemHeight;
                    const centerPosition = element.scrollTop + (element.offsetHeight / 2);
                    const selectedIndex = Math.round(centerPosition / elementHeight);
                    
                    // Remove selected class from all children
                    Array.from(children).forEach(child => child.classList.remove('selected'));
                    
                    // Add selected class to the centered child
                    if (children[selectedIndex]) {
                        children[selectedIndex].classList.add('selected');
                    }
                    
                    // Check if we need to reset scroll position
                    if (element.scrollTop < totalHeight / 2) {
                        isScrolling = true;
                        element.scrollTop += totalHeight;
                        setTimeout(() => isScrolling = false, 0);
                    } else if (element.scrollTop > totalHeight * 1.5) {
                        isScrolling = true;
                        element.scrollTop -= totalHeight;
                        setTimeout(() => isScrolling = false, 0);
                    }
                }
            });
            
            return element;
        }

        // Modify the initializeTimePicker function
        function initializeTimePicker() {
            const hourSelect = document.getElementById('hourSelect');
            const minuteSelect = document.getElementById('minuteSelect');
            
            // Create arrays for hours and minutes
            const hours = Array.from({length: 12}, (_, i) => (i + 1).toString().padStart(2, '0'));
            const minutes = Array.from({length: 60}, (_, i) => i.toString().padStart(2, '0'));
            
            // Initialize infinite scroll for hours and minutes
            createInfiniteScrollList(hourSelect, hours);
            createInfiniteScrollList(minuteSelect, minutes);

            // Setup AM/PM toggle
            const amBtn = document.getElementById('amBtn');
            const pmBtn = document.getElementById('pmBtn');
            
            amBtn.onclick = () => {
                amBtn.classList.add('selected');
                pmBtn.classList.remove('selected');
            };
            
            pmBtn.onclick = () => {
                pmBtn.classList.add('selected');
                amBtn.classList.remove('selected');
            };
        }

        function initializeAlarmSound() {
            try {
                alarmSound = new Audio('./sounds/2.mp3');
                alarmSound.loop = true;
            } catch (error) {
                console.error('Error initializing audio:', error);
            }
        }

        function setAlarm() {
            const hourElement = document.querySelector('.hours .selected');
            const minuteElement = document.querySelector('.minutes .selected');
            const isPM = document.getElementById('pmBtn').classList.contains('selected');
            
            if (!hourElement || !minuteElement) {
                alert('Please select a time');
                return;
            }
            
            let hour = parseInt(hourElement.textContent);
            const minute = minuteElement.textContent;
            
            // Convert to 24-hour format
            if (isPM && hour !== 12) hour += 12;
            if (!isPM && hour === 12) hour = 0;
            
            const alarmTime = `${hour.toString().padStart(2, '0')}:${minute}`;
            
            const alarm = {
                time: alarmTime,
                id: Date.now(),
                active: true,
                stage1Triggered: false,
                stage2Triggered: false,
                stage3Triggered: false
            };
            
            AppData.alarms.list.push(alarm);
            AppData.saveData();
            updateAlarmsList();
        }

        function checkAlarms(now) {
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            AppData.alarms.list.forEach(alarm => {
                if (!alarm.active) return;

                const [alarmHour, alarmMinute] = alarm.time.split(':').map(Number);
                
                // Calculate total seconds until alarm
                let secondsUntilAlarm = ((alarmHour - currentHour) * 3600) + 
                                      ((alarmMinute - currentMinute) * 60) - 
                                      currentSecond;
                
                if (secondsUntilAlarm < 0) {
                    secondsUntilAlarm += 24 * 3600; // Add 24 hours if alarm is for next day
                }

                // Convert to minutes for easier comparison
                const minutesUntilAlarm = Math.ceil(secondsUntilAlarm / 60);

                // Stage 1: 2 minutes before
                if (minutesUntilAlarm === 2 && !alarm.stage1Triggered) {
                    console.log("Triggering Stage 1");
                    triggerStage1(alarm);
                }
                // Stage 2: 1 minute before
                else if (minutesUntilAlarm === 1 && !alarm.stage2Triggered && alarm.stage1Triggered) {
                    console.log("Triggering Stage 2");
                    triggerStage2(alarm);
                }
                // Stage 3: At alarm time
                else if (minutesUntilAlarm === 0 && !alarm.stage3Triggered && alarm.stage2Triggered) {
                    console.log("Triggering Stage 3");
                    triggerStage3(alarm);
                }
            });
        }

        function triggerStage1(alarm) {
            try {
                const stage1Sound = new Audio('./sounds/1.mp3');
                
                stage1Sound.addEventListener('loadedmetadata', () => {
                    const duration = stage1Sound.duration * 1000; // Convert to milliseconds
                    
                    stage1Sound.play()
                        .then(() => {
                            // Wait for the entire audio file to play
                            return new Promise(resolve => {
                                setTimeout(() => {
                                    stage1Sound.pause();
                                    stage1Sound.currentTime = 0;
                                    resolve();
                                }, duration);
                            });
                        })
                        .catch(error => {
                            console.error('Error playing stage 1 sound:', error);
                        });
                });
                
                alarm.stage1Triggered = true;
                updateAlarmsList();
            } catch (error) {
                console.error('Error in stage 1:', error);
            }
        }

        function triggerStage2(alarm) {
            try {
                const stage2Sound = new Audio('./sounds/2.mp3');
                
                stage2Sound.addEventListener('loadedmetadata', () => {
                    const duration = stage2Sound.duration * 1000; // Convert to milliseconds
                    
                    stage2Sound.play()
                        .then(() => {
                            // Wait for the entire audio file to play
                            return new Promise(resolve => {
                                setTimeout(() => {
                                    stage2Sound.pause();
                                    stage2Sound.currentTime = 0;
                                    resolve();
                                }, duration);
                            });
                        })
                        .catch(error => {
                            console.error('Error playing stage 2 sound:', error);
                        });
                });
                
                alarm.stage2Triggered = true;
                updateAlarmsList();
            } catch (error) {
                console.error('Error in stage 2:', error);
            }
        }

        function triggerStage3(alarm) {
            try {
                // Call the shared readWeather function for stage 3
                readWeather();
                
                alarm.stage3Triggered = true;
                alarm.active = false; // Deactivate alarm after final stage
                updateAlarmsList();
            } catch (error) {
                console.error('Error in stage 3:', error);
                alert('Final Alarm Stage! Time to wake up! ⏰');
            }
        }

        function toggleAlarm(id) {
            const alarm = AppData.alarms.list.find(a => a.id === id);
            if (alarm) {
                alarm.active = !alarm.active;
                AppData.saveData();
                updateAlarmsList();
            }
        }

        function deleteAlarm(id) {
            AppData.alarms.list = AppData.alarms.list.filter(a => a.id !== id);
            AppData.saveData();
            updateAlarmsList();
        }

        function updateAlarmsList() {
            const alarmsList = document.getElementById('alarmsList');
            alarmsList.innerHTML = '';

            AppData.alarms.list.forEach(alarm => {
                const alarmItem = document.createElement('div');
                alarmItem.className = 'alarm-item';
                
                // Create a more detailed stages status
                const stageStatus = {
                    1: alarm.stage1Triggered ? '✓' : '○',
                    2: alarm.stage2Triggered ? '✓' : '○',
                    3: alarm.stage3Triggered ? '✓' : '○'
                };
                
                const stagesText = `Stages: ${stageStatus[1]} ${stageStatus[2]} ${stageStatus[3]}`;

                alarmItem.innerHTML = `
                    <div>
                        <span class="alarm-time">${alarm.time}</span>
                        <span class="alarm-stages">${stagesText}</span>
                    </div>
                    <div class="alarm-controls">
                        <button onclick="toggleAlarm(${alarm.id})">${alarm.active ? 'Disable' : 'Enable'}</button>
                        <button class="delete-btn" onclick="deleteAlarm(${alarm.id})">Delete</button>
                    </div>
                `;
                alarmsList.appendChild(alarmItem);
            });
        }

        // Initialize the time picker and alarm sound when the page loads
        window.onload = function() {
            initializeTimePicker();
            initializeAlarmSound();
            updateAlarmsList();
        };

        // Implement the setAlarmTime function
        window.setAlarmTime = function(time) {
            const [hours, minutes] = time.split(':');
            // Set the time in your time picker
            const hourElement = document.querySelector('.hours .selected');
            const minuteElement = document.querySelector('.minutes .selected');
            if (hourElement && minuteElement) {
                // Convert 24-hour format to 12-hour
                let displayHour = parseInt(hours);
                const isPM = displayHour >= 12;
                if (displayHour > 12) displayHour -= 12;
                if (displayHour === 0) displayHour = 12;
                
                // Update the time picker
                hourElement.textContent = displayHour.toString().padStart(2, '0');
                minuteElement.textContent = minutes;
                
                // Set AM/PM
                const amBtn = document.getElementById('amBtn');
                const pmBtn = document.getElementById('pmBtn');
                if (isPM) {
                    pmBtn.classList.add('selected');
                    amBtn.classList.remove('selected');
                } else {
                    amBtn.classList.add('selected');
                    pmBtn.classList.remove('selected');
                }
                
                // Set the alarm
                setAlarm();
            }
        };
    </script>
</body>
</html> 